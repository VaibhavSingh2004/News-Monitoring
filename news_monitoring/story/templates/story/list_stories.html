{% extends "base.html" %}

{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/story/list_stories.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

{% endblock %}

{% block content %}
  <h2 class="page-title">Stories List</h2>

  <!-- Search and Filter Section -->
  <div class="filter-container">
    <label for="search-title" class="filter-label">Search by Title:</label>
    <input type="text" id="search-title" class="filter-input" placeholder="Enter story title...">

    <label for="filter-date" class="filter-label">Filter by Date:</label>
    <input type="date" id="filter-date" class="filter-input">
  </div>

  {% if stories %}
    <div class="stories-container" id="stories-list">
      {% for story in stories %}
        <div class="story-card" data-title="{{ story.title|lower }}" data-date="{{ story.published_date|date:'Y-m-d' }}">
          <h3 class="story-title">
            <a href="{{ story.article_url }}" target="_blank">{{ story.title }}</a>
          </h3>
          <p class="story-date"><strong>Published Date:</strong> {{ story.published_date }}</p>
          <p class="story-body">{{ story.body_text|truncatewords:30 }}</p>
          <p class="story-companies">
            <strong>Tagged Companies:</strong>
            {% for company in story.tagged_companies.all %}
              {{ company.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p>

          <!-- Action Buttons -->
          <div class="story-actions">
            <a href="{% url 'story:edit' story.id %}" class="btn edit-btn">Edit</a>
            <a href="{% url 'story:delete' story.id %}" class="btn delete-btn" onclick="return confirm('Are you sure you want to delete this story?');">Delete</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="no-stories">No stories available.</p>
  {% endif %}

  <!-- Pagination Controls -->
  {% if stories.has_other_pages %}
    <div class="pagination">
      <span class="step-links">
        {% if stories.has_previous %}
          <a href="?page=1">&laquo; First</a>
          <a href="?page={{ stories.previous_page_number }}">Previous</a>
        {% endif %}

        <span class="current">
          Page {{ stories.number }} of {{ stories.paginator.num_pages }}.
        </span>

        {% if stories.has_next %}
          <a href="?page={{ stories.next_page_number }}">Next</a>
          <a href="?page={{ stories.paginator.num_pages }}">Last &raquo;</a>
        {% endif %}
      </span>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
  $(document).ready(function() {
        console.log("jQuery is loaded!");
    });
</script>
<script>
  $(document).ready(function() {
      // jQuery UI Autocomplete for search input
      $("#search-title").autocomplete({
          source: function(request, response) {
              $.ajax({
                  url: "{% url 'story:autocomplete' %}",
                  dataType: "json",
                  data: {
                      q: request.term
                  },
                  success: function(data) {
                      response(data);
                  }
              });
          },
          minLength: 2, // Start suggesting after 2 characters
          select: function(event, ui) {
              $("#search-title").val(ui.item.value);
              fetchStories();  // Fetch results after selection
          }
      });

      function fetchStories() {
          const query = $("#search-title").val();
          const date = $("#filter-date").val();

          $.ajax({
              url: "{% url 'story:search' %}",
              data: { q: query, date: date },
              dataType: "json",
              success: function(data) {
                  $("#stories-list").empty();  // Clear previous results

                  if (data.stories.length === 0) {
                      $("#stories-list").append("<p>No results found.</p>");
                      return;
                  }

                  data.stories.forEach(story => {
                      $("#stories-list").append(`
                          <div class="story-card">
                              <h3 class="story-title">
                                  <a href="${story.article_url}" target="_blank">${story.title}</a>
                              </h3>
                              <p class="story-date"><strong>Published Date:</strong> ${story.published_date}</p>
                              <p class="story-body">${story.body_text}</p>
                              <p class="story-companies"><strong>Tagged Companies:</strong> ${story.tagged_companies.join(", ")}</p>
                              <div class="story-actions">
                                  <a href="/story/edit/${story.id}/" class="btn edit-btn">Edit</a>
                                  <a href="/story/delete/${story.id}/" class="btn delete-btn" onclick="return confirm('Are you sure?');">Delete</a>
                              </div>
                          </div>`);
                  });
              }
          });
      }

      $("#search-title").on("input", fetchStories);
      $("#filter-date").on("change", fetchStories);
  });
</script>

{% endblock %}

# Testing for change HTTPS -> SSH
